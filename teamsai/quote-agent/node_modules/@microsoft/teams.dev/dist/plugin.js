"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DevtoolsPlugin = void 0;
const http_1 = __importDefault(require("http"));
const path_1 = __importDefault(require("path"));
const express_1 = __importDefault(require("express"));
const uuid = __importStar(require("uuid"));
const ws_1 = require("ws");
const teams_apps_1 = require("@microsoft/teams.apps");
const teams_common_1 = require("@microsoft/teams.common");
const package_json_1 = __importDefault(require("../package.json"));
const routes_1 = require("./routes");
let DevtoolsPlugin = class DevtoolsPlugin {
    options;
    log;
    id;
    name;
    httpPlugin;
    $onError;
    $onActivity;
    http;
    express;
    ws;
    sockets = new Map();
    pending = {};
    pages = [];
    constructor(options = {}) {
        this.options = options;
        const dist = path_1.default.join(__dirname, 'devtools-web');
        this.express = (0, express_1.default)();
        this.http = http_1.default.createServer(this.express);
        this.ws = new ws_1.WebSocketServer({ server: this.http, path: '/devtools/sockets' });
        this.ws.on('connection', this.onSocketConnection.bind(this));
        this.express.use('/devtools', express_1.default.static(dist));
        this.express.get('/devtools/*', (_, res) => {
            res.sendFile(path_1.default.join(dist, 'index.html'));
        });
        this.options = options;
    }
    /**
     * add a custom page to the devtools
     * @param page the page to add
     */
    addPage(page) {
        this.pages.push(page);
        return this;
    }
    onInit() {
        this.log.warn(new teams_common_1.String()
            .bold(new teams_common_1.String().yellow('⚠️  Devtools are not secure and should not be used production environments ⚠️'))
            .toString());
    }
    onStart({ port }) {
        const numericPort = this.options.customPort ?? (typeof port === 'string' ? parseInt(port, 10) + 1 : port + 1);
        this.express.use((0, routes_1.router)({
            port: numericPort,
            log: this.log,
            process: (token, activity) => {
                return new Promise((resolve, reject) => {
                    this.pending[activity.id] = { resolve, reject };
                    this.$onActivity({
                        sender: this.httpPlugin,
                        token,
                        activity,
                    });
                });
            },
        }));
        return new Promise((resolve, reject) => {
            this.http.on('error', (error) => {
                this.$onError({ error });
                return reject(error);
            });
            this.http.listen(numericPort, async () => {
                this.log.info(`available at http://localhost:${numericPort}/devtools`);
                resolve();
            });
        });
    }
    onActivity({ activity, conversation }) {
        this.emitActivityToSockets({
            id: uuid.v4(),
            type: 'activity.received',
            chat: conversation,
            body: activity,
            sentAt: new Date(),
        });
    }
    onActivitySent({ activity, conversation }) {
        this.emitActivityToSockets({
            id: uuid.v4(),
            type: 'activity.sent',
            chat: conversation,
            body: activity,
            sentAt: new Date(),
        });
    }
    onActivityResponse({ activity, response }) {
        const promise = this.pending[activity.id];
        if (!promise)
            return;
        promise.resolve(response);
        delete this.pending[activity.id];
    }
    async send(activity, ref) {
        return await this.httpPlugin.send(activity, ref);
    }
    createStream(ref) {
        return this.httpPlugin.createStream(ref);
    }
    onSocketConnection(socket) {
        const id = uuid.v4();
        this.sockets.set(id, socket);
        socket.send(JSON.stringify({
            id: uuid.v4(),
            type: 'metadata',
            body: {
                id: this.id?.toString(),
                name: this.name?.toString(),
                pages: this.pages,
            },
            sentAt: new Date(),
        }));
        socket.on('disconnect', () => {
            this.sockets.delete(id);
        });
    }
    emitToSockets(event) {
        for (const socket of this.sockets.values()) {
            socket.send(JSON.stringify(event));
        }
    }
    emitActivityToSockets(event) {
        for (const socket of this.sockets.values()) {
            socket.send(JSON.stringify(event));
        }
    }
};
exports.DevtoolsPlugin = DevtoolsPlugin;
__decorate([
    (0, teams_apps_1.Logger)(),
    __metadata("design:type", Object)
], DevtoolsPlugin.prototype, "log", void 0);
__decorate([
    (0, teams_apps_1.Dependency)({ optional: true }),
    __metadata("design:type", Object)
], DevtoolsPlugin.prototype, "id", void 0);
__decorate([
    (0, teams_apps_1.Dependency)({ optional: true }),
    __metadata("design:type", Object)
], DevtoolsPlugin.prototype, "name", void 0);
__decorate([
    (0, teams_apps_1.Dependency)(),
    __metadata("design:type", teams_apps_1.HttpPlugin)
], DevtoolsPlugin.prototype, "httpPlugin", void 0);
__decorate([
    (0, teams_apps_1.Event)('error'),
    __metadata("design:type", Function)
], DevtoolsPlugin.prototype, "$onError", void 0);
__decorate([
    (0, teams_apps_1.Event)('activity'),
    __metadata("design:type", Function)
], DevtoolsPlugin.prototype, "$onActivity", void 0);
exports.DevtoolsPlugin = DevtoolsPlugin = __decorate([
    (0, teams_apps_1.Plugin)({
        name: 'devtools',
        version: package_json_1.default.version,
        description: ['a set of tools to make development', 'of teams apps faster and simpler'].join('\n'),
    }),
    __metadata("design:paramtypes", [Object])
], DevtoolsPlugin);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3BsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxnREFBd0I7QUFDeEIsZ0RBQXdCO0FBRXhCLHNEQUE4QjtBQUU5QiwyQ0FBNkI7QUFFN0IsMkJBQWdEO0FBR2hELHNEQWMrQjtBQUMvQiwwREFBMEQ7QUFFMUQsbUVBQWtDO0FBR2xDLHFDQUFrQztBQW1CM0IsSUFBTSxjQUFjLEdBQXBCLE1BQU0sY0FBYztJQTBCSjtJQXhCWixHQUFHLENBQVc7SUFHZCxFQUFFLENBQVU7SUFHWixJQUFJLENBQVU7SUFHZCxVQUFVLENBQWM7SUFHeEIsUUFBUSxDQUFnQztJQUd4QyxXQUFXLENBQW1DO0lBRTdDLElBQUksQ0FBYztJQUNsQixPQUFPLENBQXNCO0lBQzdCLEVBQUUsQ0FBa0I7SUFDcEIsT0FBTyxHQUFHLElBQUksR0FBRyxFQUFxQixDQUFDO0lBQ3ZDLE9BQU8sR0FBd0MsRUFBRSxDQUFDO0lBQ2xELEtBQUssR0FBZ0IsRUFBRSxDQUFDO0lBRWxDLFlBQXFCLFVBQWlDLEVBQUU7UUFBbkMsWUFBTyxHQUFQLE9BQU8sQ0FBNEI7UUFDdEQsTUFBTSxJQUFJLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFBLGlCQUFPLEdBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxHQUFHLGNBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxvQkFBZSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMs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